<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tomar asistencia</title>
<style>
  :root{ --primary:#4A90E2; --success:#28a745; --warning:#ffc107; --danger:#dc3545; }
  *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,Segoe UI,Roboto,sans-serif}
  body{background:#f5f6fb;color:#2b2f36}
  header{background:linear-gradient(135deg,var(--primary),#2E5FAA);color:#fff;padding:18px 0;text-align:center}
  .container{max-width:900px;margin:0 auto;padding:22px}
  .card{background:#fff;border-radius:14px;padding:22px;border:1px solid #e6ebf3;box-shadow:0 6px 18px rgba(0,0,0,.05);margin-top:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
  .form-control{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:14px}
  .legend{display:flex;gap:12px;align-items:center;font-size:14px;color:#445}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block}
  .p{background:var(--success)} .t{background:var(--warning)} .a{background:var(--danger)}
  .attendance-row{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #eee}
  .radio-group{display:flex;gap:8px}
  .radio-group input{display:none}
  .radio-group label{padding:6px 12px;border:1px solid #ccc;border-radius:6px;cursor:pointer;font-size:14px}
  .radio-group input:checked+label{background:var(--primary);color:#fff;border-color:var(--primary)}
  .btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,var(--primary),#2E5FAA);color:#fff;text-decoration:none;padding:10px 16px;border-radius:10px;font-weight:600;border:none;cursor:pointer}
  .btn-outline{background:transparent;color:var(--primary);border:1px solid var(--primary)}
  .msg{margin-top:12px;padding:10px;border-radius:8px;font-size:14px}
  .ok{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
  .err{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
  .login-form {max-width: 420px; margin: 40px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);}
  .login-form input {width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px;}
  .add-student {display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:16px;}
  .add-student input {flex:1 1 260px;}
</style>
</head>
<body>
<header>
  <h1>Tomar asistencia</h1>
  <p id="ctx"></p>
</header>

<div class="container">
  <!-- Acceso por c√≥digo -->
  <div id="codeAccess" class="card login-form" style="display:none;">
    <h2>Acceso por c√≥digo</h2>
    <input id="accessCode" class="form-control" placeholder="Ingresa el c√≥digo de acceso">
    <button id="btnAccess" class="btn">Acceder</button>
    <div id="codeMsg" class="msg" style="display:none; margin-top:12px"></div>
  </div>

  <!-- Interfaz principal -->
  <div id="attendanceInterface" class="card" style="display:none;">
    <div class="row">
      <div>
        <label for="fechaAsis">Fecha:</label>
        <input id="fechaAsis" type="date" class="form-control"/>
        <div class="legend" style="margin-top:6px">
          <span class="dot p"></span> A = Asistencia &nbsp;&nbsp;
          <span class="dot t"></span> R = Retardo &nbsp;&nbsp;
          <span class="dot a"></span> F = Falta
        </div>
      </div>
      <div style="margin-left:auto">
        <a id="btnBack" class="btn-outline btn" href="opcionesgrupo.html">‚Üê Regresar</a>
      </div>
    </div>

    <!-- Acciones r√°pidas -->
    <div style="margin-top:0;display:flex;gap:8px;flex-wrap:wrap">
      <button id="markAllA" class="btn">‚úì Todos A (asistencia)</button>
      <button id="markAllF" class="btn-outline btn">‚úó Todos F (falta)</button>
      <button id="saveAsis" class="btn" style="margin-left:auto">üíæ Guardar asistencia</button>
    </div>

    <!-- Agregar alumno manual -->
    <div class="add-student">
      <input id="newStudentName" class="form-control" placeholder="Nombre del alumno (p. ej. Juan P√©rez)"/>
      <button id="addStudentBtn" class="btn">‚ûï Agregar alumno</button>
    </div>

    <!-- Lista -->
    <div id="asisList" style="margin-top:8px"><p>Ingresa un c√≥digo de acceso para comenzar.</p></div>

    <div id="msg" class="msg" style="display:none"></div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, collectionGroup, getDocs, getDoc, setDoc, doc, serverTimestamp, addDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ===== Firebase =====
  const app = initializeApp({
    apiKey: "AIzaSyBEIeZz3HeU-8EVirVx9JAYnGbBegh1Uh4",
    authDomain: "maestros-7faa6.firebaseapp.com",
    projectId: "maestros-7faa6",
    storageBucket: "maestros-7faa6.firebasestorage.app",
    messagingSenderId: "328284079222",
    appId: "1:328284079222:web:f0ab5c3443469d145d4b57",
    measurementId: "G-YKBQD9EJH3"
  });
  const db  = getFirestore(app);

  // ===== UI =====
  const codeAccessDiv = document.getElementById('codeAccess');
  const attendanceInterface = document.getElementById('attendanceInterface');
  const accessCodeInput = document.getElementById('accessCode');
  const btnAccess = document.getElementById('btnAccess');
  const codeMsg = document.getElementById('codeMsg');
  const fechaAsis = document.getElementById('fechaAsis');
  const asisList = document.getElementById('asisList');
  const msg = document.getElementById('msg');
  const markAllA = document.getElementById('markAllA');
  const markAllF = document.getElementById('markAllF');
  const saveAsis = document.getElementById('saveAsis');
  const btnBack = document.getElementById('btnBack');
  const ctx = document.getElementById('ctx');
  const newStudentName = document.getElementById('newStudentName');
  const addStudentBtn  = document.getElementById('addStudentBtn');

  // ===== Estado =====
  let alumnos = [];
  let asistencia = {};
  let currentSid = null;
  let currentGid = null;
  let allowedGroups = [];
  let currentCode = null; // << mantiene el ?code activo
  let m = null; // maestro resuelto

  // ===== Helpers =====
  // Comparador para espa√±ol (ignora acentos, puntuaci√≥n y toma n√∫meros)
  const coll = new Intl.Collator('es', { sensitivity: 'base', ignorePunctuation: true, numeric: true });

  const p = new URLSearchParams(location.search);
  const sidParam = p.get('sid');
  const gidParam = p.get('gid');
  currentCode = p.get('code') || null; // << toma code si ven√≠a en la URL

  function todayStr(){ return new Date().toISOString().slice(0,10); }
  fechaAsis.value = todayStr();

  function showMsg(el, text, kind='ok'){
    el.style.display='block';
    el.className = `msg ${kind==='ok'?'ok':'err'}`;
    el.textContent = text;
    setTimeout(()=>el.style.display='none', 3200);
  }

  // Normaliza para comparar nombres (sin acentos y min√∫sculas)
  function normalizeName(s=''){
    return s.normalize('NFD').replace(/\p{Diacritic}/gu, '').toLowerCase().trim();
  }

  // === Resolver m (maestro) a partir de sid ===
  async function resolveMaestroBySchoolId(sid){
    const cg = await getDocs(collectionGroup(db, 'escuelas'));
    const found = cg.docs.find(d => d.id === sid);
    if (!found) return null;
    return found.ref.parent.parent?.id || null; // maestros/{m}
  }

  // ==== Flujo de inicio ====
  if (sidParam && gidParam){
    // Modo admin o ‚Äúadmin con code propagado‚Äù
    currentSid = sidParam;
    currentGid = gidParam;
    ctx.textContent = `Escuela: ${currentSid} ¬∑ Grupo: ${currentGid}`;

    // Back preservando ?code si ven√≠a
    btnBack.href = currentCode
      ? `opcionesgrupo.html?sid=${encodeURIComponent(currentSid)}&gid=${encodeURIComponent(currentGid)}&code=${encodeURIComponent(currentCode)}`
      : `opcionesgrupo.html?sid=${encodeURIComponent(currentSid)}&gid=${encodeURIComponent(currentGid)}`;

    m = await resolveMaestroBySchoolId(currentSid);
    if(!m){ showMsg(msg, 'No se encontr√≥ la escuela bajo ning√∫n maestro.', 'err'); }
    else { codeAccessDiv.style.display='none'; attendanceInterface.style.display='block'; await initializeAttendance(); }
  } else {
    // Acceso por c√≥digo (a√∫n no validado)
    codeAccessDiv.style.display='block';
    attendanceInterface.style.display='none';
    ctx.textContent = 'Acceso por c√≥digo';
    btnBack.href = './index.html';
  }

  // === Acceso por c√≥digo ===
  btnAccess.addEventListener('click', async () => {
    const code = accessCodeInput.value.trim();
    if(!code){ showMsg(codeMsg, 'Ingresa un c√≥digo de acceso', 'err'); return; }

    try {
      const codeRef = doc(db, 'accesos', code);
      const codeSnap = await getDoc(codeRef);
      if(!codeSnap.exists()){ showMsg(codeMsg, 'C√≥digo inv√°lido', 'err'); return; }

      const codeData = codeSnap.data();
      if(!codeData.activo){ showMsg(codeMsg, 'Este c√≥digo ya no est√° activo', 'err'); return; }

      currentCode = code; // << guarda el code activo
      currentSid = codeData.escuelaId;
      allowedGroups = Array.isArray(codeData.grupos) ? codeData.grupos : [];

      if(!currentSid || !allowedGroups.length){ showMsg(codeMsg, 'El c√≥digo no tiene escuela/grupos asignados', 'err'); return; }

      // Resolver maestro y continuar
      m = await resolveMaestroBySchoolId(currentSid);
      if(!m){ showMsg(codeMsg, 'No se encontr√≥ la escuela bajo ning√∫n maestro.', 'err'); return; }

      // Mientras est√° el selector (si hay varios), Back va a lista de grupos permitidos
      btnBack.href = `grupos.html?sid=${encodeURIComponent(currentSid)}&code=${encodeURIComponent(currentCode)}`;

      if (allowedGroups.length === 1){
        currentGid = allowedGroups[0];
        await loadGroupInfo(currentSid, currentGid);
      } else {
        await showGroupSelector(currentSid, allowedGroups);
      }

      codeAccessDiv.style.display = 'none';
      attendanceInterface.style.display = 'block';
    } catch (e){
      console.error('Error verificando c√≥digo:', e);
      showMsg(codeMsg, 'Error al verificar el c√≥digo', 'err');
    }
  });

  // Selector de grupo (si hay varios)
  async function showGroupSelector(schoolId, groupIds){
    // Obtener nombres desde ruta anidada
    const groupsInfo = [];
    for (const gid of groupIds){
      const gref = doc(db, 'maestros', m, 'escuelas', schoolId, 'grupos', gid);
      const gsnap = await getDoc(gref);
      groupsInfo.push({ id: gid, name: gsnap.exists() ? (gsnap.data().name || gid) : gid });
    }
    asisList.innerHTML = `
      <h3>Selecciona un grupo:</h3>
      <div style="display:flex; flex-direction:column; gap:10px; margin-top:15px;">
        ${groupsInfo.map(g=>`
          <button class="btn" data-g="${g.id}">${g.name}</button>
        `).join('')}
      </div>
    `;
    asisList.querySelectorAll('button[data-g]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        currentGid = btn.getAttribute('data-g');
        await loadGroupInfo(currentSid, currentGid);
      });
    });
    ctx.textContent = `Escuela: ${schoolId} ¬∑ Selecciona grupo`;
  }

  // Cargar nombre y preparar interfaz para un grupo
  async function loadGroupInfo(schoolId, groupId){
    try{
      const gref = doc(db, 'maestros', m, 'escuelas', schoolId, 'grupos', groupId);
      const gsnap = await getDoc(gref);
      const gname = gsnap.exists() ? (gsnap.data().name || groupId) : groupId;
      ctx.textContent = `Escuela: ${schoolId} ¬∑ Grupo: ${gname}`;

      // Back a opciones del grupo, preservando ?code si existe
      btnBack.href = currentCode
        ? `opcionesgrupo.html?sid=${encodeURIComponent(schoolId)}&gid=${encodeURIComponent(groupId)}&code=${encodeURIComponent(currentCode)}`
        : `opcionesgrupo.html?sid=${encodeURIComponent(schoolId)}&gid=${encodeURIComponent(groupId)}`;

      await initializeAttendance();
    }catch(e){
      console.error('Error cargando informaci√≥n del grupo:', e);
      showMsg(msg, 'Error al cargar informaci√≥n del grupo', 'err');
    }
  }

  async function initializeAttendance(){
    await loadAlumnos();
    await loadAsistenciaForDate(fechaAsis.value || todayStr());
  }

  // === Cargar alumnos (ordenados A‚ÄìZ en espa√±ol) ===
  async function loadAlumnos(){
    alumnos = [];
    try{
      const snap = await getDocs(collection(db, 'maestros', m, 'escuelas', currentSid, 'grupos', currentGid, 'alumnos'));
      snap.forEach(d=> alumnos.push({ id: d.id, name: d.data().name || '' }));
      alumnos.sort((a, b) => coll.compare(a.name || '', b.name || '')); // ‚Üê orden A‚ÄìZ
      renderAsis();
    }catch(e){
      console.error('Error cargando alumnos:', e);
      showMsg(msg, 'Error al cargar los alumnos', 'err');
    }
  }

  function renderAsis(){
    if(!alumnos.length){ asisList.innerHTML = '<p>No hay alumnos en este grupo.</p>'; return; }
    asisList.innerHTML = '';
    alumnos.forEach(a=>{
      const row = document.createElement('div');
      row.className = 'attendance-row';
      row.innerHTML = `
        <div>${a.name}</div>
        <div class="radio-group">
          <input type="radio" name="r-${a.id}" id="rA-${a.id}" ${asistencia[a.id]==='A'?'checked':''}>
          <label for="rA-${a.id}">A</label>
          <input type="radio" name="r-${a.id}" id="rR-${a.id}" ${asistencia[a.id]==='R'?'checked':''}>
          <label for="rR-${a.id}">R</label>
          <input type="radio" name="r-${a.id}" id="rF-${a.id}" ${asistencia[a.id]==='F'?'checked':''}>
          <label for="rF-${a.id}">F</label>
        </div>
      `;
      asisList.appendChild(row);
      row.querySelector(`#rA-${a.id}`).addEventListener('change',()=>asistencia[a.id]='A');
      row.querySelector(`#rR-${a.id}`).addEventListener('change',()=>asistencia[a.id]='R');
      row.querySelector(`#rF-${a.id}`).addEventListener('change',()=>asistencia[a.id]='F');
    });
  }

  async function loadAsistenciaForDate(dateId){
    asistencia = {};
    alumnos.forEach(a=> asistencia[a.id] = 'A');
    try{
      const ref = doc(db, 'maestros', m, 'escuelas', currentSid, 'grupos', currentGid, 'asistencias', dateId);
      const snap = await getDoc(ref);
      if(snap.exists()){
        const regs = snap.data()?.registros || {};
        Object.entries(regs).forEach(([aid, st])=>{
          if(aid in asistencia){
            const v = String(st||'A').toUpperCase();
            asistencia[aid] = (v==='A'||v==='R'||v==='F') ? v : 'A';
          }
        });
        renderAsis();
        showMsg(msg, `Asistencia del ${dateId} cargada.`, 'ok');
      }else{
        renderAsis();
        showMsg(msg, `Sin registro previo para ${dateId}.`, 'ok');
      }
    }catch(e){
      console.error(e);
      renderAsis();
      showMsg(msg, 'No se pudo cargar la asistencia guardada.', 'err');
    }
  }

  // === Agregar alumno manual ===
  addStudentBtn.addEventListener('click', async ()=>{
    const raw = newStudentName.value.trim();
    if(!raw){ showMsg(msg, 'Escribe el nombre del alumno.','err'); return; }
    if(!currentSid || !currentGid || !m){ showMsg(msg, 'Primero selecciona un grupo.','err'); return; }

    // Validar duplicados por nombre (ignorando acentos/may√∫sculas)
    const norm = normalizeName(raw);
    const exists = alumnos.some(a => normalizeName(a.name) === norm);
    if(exists){ showMsg(msg, 'Ese alumno ya existe en el grupo.','err'); return; }

    try{
      // Guardar en Firestore
      const colRef = collection(db, 'maestros', m, 'escuelas', currentSid, 'grupos', currentGid, 'alumnos');
      const created = await addDoc(colRef, {
        name: raw,
        createdAt: serverTimestamp()
      });

      // Actualizar estado local, reordenar y re-render
      alumnos.push({ id: created.id, name: raw });
      alumnos.sort((a, b) => coll.compare(a.name || '', b.name || ''));
      renderAsis();

      // Por defecto, marcar A para este nuevo alumno en el d√≠a actual seleccionado
      asistencia[created.id] = 'A';

      newStudentName.value = '';
      showMsg(msg, 'Alumno agregado correctamente.','ok');
    }catch(e){
      console.error('Error agregando alumno:', e);
      showMsg(msg, 'No se pudo agregar el alumno.','err');
    }
  });

  // === Acciones r√°pidas ===
  markAllA.addEventListener('click', ()=>{ alumnos.forEach(a=>asistencia[a.id]='A'); renderAsis(); });
  markAllF.addEventListener('click', ()=>{ alumnos.forEach(a=>asistencia[a.id]='F'); renderAsis(); });

  fechaAsis.addEventListener('change', ()=> loadAsistenciaForDate(fechaAsis.value || todayStr()));

  saveAsis.addEventListener('click', async ()=>{
    if(!alumnos.length){ showMsg(msg, 'No hay alumnos para guardar.','err'); return; }
    const dateId = fechaAsis.value || todayStr();
    const registros = {};
    alumnos.forEach(a=> registros[a.id] = asistencia[a.id] || 'A');
    try{
      await setDoc(
        doc(db, 'maestros', m, 'escuelas', currentSid, 'grupos', currentGid, 'asistencias', dateId),
        { date: dateId, registros, updatedAt: serverTimestamp() },
        { merge: true }
      );
      showMsg(msg, 'Asistencia del d√≠a guardada correctamente ‚úî');
    }catch(e){
      console.error(e);
      showMsg(msg, 'Error al guardar asistencia','err');
    }
  });

  // UX: Enter en el input de c√≥digo
  accessCodeInput?.addEventListener('keyup', e=>{ if(e.key==='Enter') btnAccess.click(); });

  // UX: Enter en el input de nuevo alumno
  newStudentName?.addEventListener('keyup', e=>{ if(e.key==='Enter') addStudentBtn.click(); });
</script>
</body>
</html>
